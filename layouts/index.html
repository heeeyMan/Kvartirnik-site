{{ define "main" }}
<div class="pa3 pa4-ns w-100 w-70-ns center">
  
  <!-- –ë–ª–æ–∫ —Å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º –∫–≤–∞—Ä—Ç–∏—Ä–Ω–∏–∫–æ–º -->
  {{ $kvartirniki := where site.RegularPages "Section" "kvartirniki" }}
  {{ $now := now }}
  
  {{ if $kvartirniki }}
    <!-- –ù–∞—Ö–æ–¥–∏–º –±–ª–∏–∂–∞–π—à–∏–π –±—É–¥—É—â–∏–π –∫–≤–∞—Ä—Ç–∏—Ä–Ω–∏–∫ -->
    {{ $futureKvartirniki := where $kvartirniki "Date" "ge" $now }}
    {{ $nearestFutureKvartirnik := cond (gt (len $futureKvartirniki) 0) 
        (index ($futureKvartirniki.ByDate) 0) 
        nil }}
    
    <!-- –ù–∞—Ö–æ–¥–∏–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–æ—à–µ–¥—à–∏–π –∫–≤–∞—Ä—Ç–∏—Ä–Ω–∏–∫ -->
    {{ $pastKvartirniki := where $kvartirniki "Date" "lt" $now }}
    {{ $lastPastKvartirnik := cond (gt (len $pastKvartirniki) 0)
        (index ($pastKvartirniki.ByDate.Reverse) 0)
        nil }}

<!-- ===== –£–ü–†–û–©–ï–ù–ù–´–ô –ë–õ–û–ö: –î–ò–ù–ê–ú–ò–ß–ï–°–ö–ò–ô –ó–ê–ì–û–õ–û–í–û–ö ===== -->
{{ if $nearestFutureKvartirnik }}
  <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –¥–∞—Ç–æ–π –∏ –≤—Ä–µ–º–µ–Ω–µ–º - –ø—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ Google –ö–∞–ª–µ–Ω–¥–∞—Ä—å -->
  <h1 class="f1 tc mb3" style="color: #5a1700;">
    <a href="https://calendar.google.com/calendar/r/eventedit?text={{ $nearestFutureKvartirnik.Title | urlquery }}&details=–ö–≤–∞—Ä—Ç–∏—Ä–Ω–∏–∫ {{ $nearestFutureKvartirnik.Date.Format "02.01.2006" }} –≤ {{ $nearestFutureKvartirnik.Params.time }}&location={{ $nearestFutureKvartirnik.Params.location | urlquery }}"
       target="_blank"
       class="no-underline hover-black-70"
       style="color: #5a1700 !important; cursor: pointer; text-decoration: none;">
      {{ $nearestFutureKvartirnik.Date.Format "02.01.2006" }} | {{ $nearestFutureKvartirnik.Params.time }}
    </a>
  </h1>
  
  <!-- –ë–ª–æ–∫ —Å –ª–æ–∫–∞—Ü–∏–µ–π - –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–π –¥–ª—è –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç -->
  {{ if $nearestFutureKvartirnik.Params.location }}
    <h2 class="f2 tc mb3" style="color: #5a1700;">
      {{ if $nearestFutureKvartirnik.Params.yandex_maps_link }}
        <a href="{{ $nearestFutureKvartirnik.Params.yandex_maps_link }}" 
           target="_blank" 
           class="no-underline black hover-black-70 flex items-center justify-center"
           style="color: #5a1700 !important;">
      {{ else }}
        <div class="flex items-center justify-center">
      {{ end }}
      
          <!-- SVG –∏–∫–æ–Ω–∫–∞ –ª–æ–∫–∞—Ü–∏–∏ -->
          <svg class="dib mr2" fill="currentColor" viewBox="0 0 24 24" style="width: 62px; height: 62px; vertical-align: middle;">
            <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
          </svg>
          
          <!-- –ê–¥—Ä–µ—Å –ª–æ–∫–∞—Ü–∏–∏ -->
          <span style="font-family: 'Courier New', monospace; font-weight: normal;">
            {{ $nearestFutureKvartirnik.Params.location }}
          </span>
      
      {{ if $nearestFutureKvartirnik.Params.yandex_maps_link }}
        </a>
      {{ else }}
        </div>
      {{ end }}
    </h2>
  {{ end }}
  
  <!-- –ö–Ω–æ–ø–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
  <div class="tc mb4">
    <a href="#registration" class="dib ph4 pv3 bg-yellow white br2 f3 fw6 no-underline hover-bg-dark-blue">
      –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
    </a>
  </div>
{{ else }}
  <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–æ–≥–¥–∞ –Ω–µ—Ç –±—É–¥—É—â–∏—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π -->
  <h1 class="f1 tc mb4">–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è</h1>
{{ end }}

    <!-- ===== –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ù–¢ ===== -->
    {{ if $nearestFutureKvartirnik }}
      <!-- –ï—Å—Ç—å –±—É–¥—É—â–∏–µ –∫–≤–∞—Ä—Ç–∏—Ä–Ω–∏–∫–∏ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º "—É–∂–µ —Å–∫–æ—Ä–æ" -->
      <section class="main-event">
        <div class="upcoming-message mb4">
          <p class="f4 tc ma0">–£–∂–µ —Å–∫–æ—Ä–æ —Å–æ—Å—Ç–æ–∏—Ç—Å—è –Ω–∞—à –æ—á–µ—Ä–µ–¥–Ω–æ–π –∫–≤–∞—Ä—Ç–∏—Ä–Ω–∏–∫!</p>
          <p class="f4 tc ma0">–ù–µ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç–µ —Å–∞–º–æ–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ —ç—Ç–æ–≥–æ —Å–µ–∑–æ–Ω–∞</p>
        </div>
        
        <a href="{{ $nearestFutureKvartirnik.RelPermalink }}" class="link black dim">
          <div class="event-card">
            <div class="event-image">
              {{ with $nearestFutureKvartirnik.Params.featured_image }}
                <img src="{{ . }}" alt="{{ $nearestFutureKvartirnik.Title }}" class="w-100">
              {{ else }}
                <div class="placeholder-image">–§–æ—Ç–æ –∞—Ñ–∏—à–∏</div>
              {{ end }}
            </div>
            
            <div class="event-content">
              <h3 class="f3 ma0 mb2">{{ $nearestFutureKvartirnik.Title }}</h3>
              <div class="event-date mb2">
                {{ $nearestFutureKvartirnik.Date.Format "2 January 2006" }}
                {{ with $nearestFutureKvartirnik.Params.time }}
                  ‚Ä¢ <span class="event-time">{{ . }}</span>
                {{ end }}
                <span class="status-badge future">–ü—Ä–µ–¥—Å—Ç–æ–∏—Ç</span>
              </div>
              <p class="event-excerpt ma0">
                {{ $nearestFutureKvartirnik.Summary | plainify | truncate 120 }}
              </p>
            </div>
          </div>
        </a>
      </section>

    {{ else if $lastPastKvartirnik }}
      <!-- –ù–µ—Ç –±—É–¥—É—â–∏—Ö, –Ω–æ –µ—Å—Ç—å –ø—Ä–æ—à–µ–¥—à–∏–µ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π -->
      <section class="main-event">
        <div class="no-upcoming-events mb4">
          <p class="f4 tc ma0">–í –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è –∫–≤–∞—Ä—Ç–∏—Ä–Ω–∏–∫–∏ –Ω–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω—ã :(</p>
          <p class="f4 tc ma0">–ê –ø–æ–∫–∞ –ø–æ—Å–º–æ—Ç—Ä–∏—Ç–µ, –∫–∞–∫ –ø—Ä–æ—à–µ–ª –Ω–∞—à –ø–æ—Å–ª–µ–¥–Ω–∏–π –∫–≤–∞—Ä—Ç–∏—Ä–Ω–∏–∫</p>
        </div>
        
        <a href="{{ $lastPastKvartirnik.RelPermalink }}" class="link black dim">
          <div class="event-card">
            <div class="event-image">
              {{ with $lastPastKvartirnik.Params.featured_image }}
                <img src="{{ . }}" alt="{{ $lastPastKvartirnik.Title }}" class="w-100">
              {{ else }}
                <div class="placeholder-image">–§–æ—Ç–æ –∞—Ñ–∏—à–∏</div>
              {{ end }}
            </div>
            
            <div class="event-content">
              <h3 class="f3 ma0 mb2">{{ $lastPastKvartirnik.Title }}</h3>
              <div class="event-date mb2">
                {{ $lastPastKvartirnik.Date.Format "2 January 2006" }}
                {{ with $lastPastKvartirnik.Params.time }}
                  ‚Ä¢ <span class="event-time">{{ . }}</span>
                {{ end }}
                <span class="status-badge past">–°–æ—Å—Ç–æ—è–ª—Å—è</span>
              </div>
              <p class="event-excerpt ma0">
                {{ $lastPastKvartirnik.Summary | plainify | truncate 120 }}
              </p>
            </div>
          </div>
        </a>
      </section>
    {{ end }}

  {{ else }}
    <!-- –ù–µ—Ç –Ω–∏–∫–∞–∫–∏—Ö –∫–≤–∞—Ä—Ç–∏—Ä–Ω–∏–∫–æ–≤ –≤–æ–æ–±—â–µ -->
    <h1 class="f1 tc mb4">–ö–∞–º–∏–Ω</h1>
    
    <div class="no-events tc pa5">
      <h2 class="f2 mb3">–í –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è –∫–≤–∞—Ä—Ç–∏—Ä–Ω–∏–∫–∏ –Ω–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω—ã</h2>
      <p class="f4 mb4">–°–ª–µ–¥–∏—Ç–µ –∑–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏ –≤ –Ω–∞—à–∏—Ö —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç—è—Ö</p>
      <div class="event-placeholder">
        <div class="placeholder-icon">üéµ</div>
        <p>–°–∫–æ—Ä–æ –∑–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–æ–≤—ã—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è—Ö</p>
      </div>
    </div>
  {{ end }}

</div>

<!-- ===== –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –î–õ–Ø –î–û–ë–ê–í–õ–ï–ù–ò–Ø –í –ö–ê–õ–ï–ù–î–ê–†–¨ ===== -->
<div id="calendar-modal" class="fixed top-0 left-0 w-100 h-100 bg-black-70 z-999" style="display: none;">
  <div class="fixed top-50 left-50 bg-white br3 pa4 shadow-4" style="transform: translate(-50%, -50%); max-width: 400px;">
    <h3 class="f3 mb3">–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—å</h3>
    <p class="f5 mb3">–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è:</p>
    
    <div class="flex flex-wrap">
      <!-- –°—Å—ã–ª–∫–∞ –Ω–∞ Google –ö–∞–ª–µ–Ω–¥–∞—Ä—å -->
      <a id="google-calendar" class="dib pa3 mb2 mr2 bg-blue white br2 no-underline f6 hover-bg-dark-blue" target="_blank">
        Google –ö–∞–ª–µ–Ω–¥–∞—Ä—å
      </a>
      <!-- –°—Å—ã–ª–∫–∞ –Ω–∞ Outlook -->
      <a id="outlook-calendar" class="dib pa3 mb2 mr2 bg-dark-blue white br2 no-underline f6 hover-bg-blue" target="_blank">
        Outlook
      </a>
      <!-- –°–∫–∞—á–∏–≤–∞–Ω–∏–µ .ics —Ñ–∞–π–ª–∞ -->
      <a id="ics-download" class="dib pa3 mb2 bg-green white br2 no-underline f6 hover-bg-dark-green">
        –°–∫–∞—á–∞—Ç—å .ics
      </a>
    </div>
    
    <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è -->
    <button onclick="closeCalendarModal()" class="db w-100 pa2 mt3 bg-gray white br2 f6">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>

<!-- ===== JavaScript –î–õ–Ø –†–ê–ë–û–¢–´ –° –ö–ê–õ–ï–ù–î–ê–†–ï–ú ===== -->
<script>
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—å
function addToCalendar(title, dateString, time, location) {
  console.log('addToCalendar called with:', {title, dateString, time, location});
  
  try {
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è
    const eventDate = new Date(dateString);
    console.log('Parsed date:', eventDate);
    
    if (time && time.includes(':')) {
      const [hours, minutes] = time.split(':');
      eventDate.setHours(parseInt(hours), parseInt(minutes));
      console.log('Time set to:', hours, minutes);
    }
    
    const endDate = new Date(eventDate);
    endDate.setHours(eventDate.getHours() + 2); // +2 —á–∞—Å–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–ª—è Google Calendar
    const startGoogle = eventDate.toISOString().replace(/-|:|\.\d+/g, '');
    const endGoogle = endDate.toISOString().replace(/-|:|\.\d+/g, '');
    
    // –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π
    const googleLink = `https://calendar.google.com/calendar/r/eventedit?text=${encodeURIComponent(title)}&dates=${startGoogle}/${endGoogle}&details=${encodeURIComponent('–ö–≤–∞—Ä—Ç–∏—Ä–Ω–∏–∫')}&location=${encodeURIComponent(location)}`;
    const outlookLink = `https://outlook.live.com/calendar/0/deeplink/compose?subject=${encodeURIComponent(title)}&startdt=${eventDate.toISOString()}&enddt=${endDate.toISOString()}&location=${encodeURIComponent(location)}`;
    
    console.log('Google link:', googleLink);
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Å—ã–ª–∫–∏ –≤ –∫–Ω–æ–ø–∫–∏
    document.getElementById('google-calendar').href = googleLink;
    document.getElementById('outlook-calendar').href = outlookLink;
    
    // –°–æ–∑–¥–∞–µ–º .ics —Ñ–∞–π–ª –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
    const icsContent = [
      'BEGIN:VCALENDAR',
      'VERSION:2.0',
      'BEGIN:VEVENT',
      `SUMMARY:${title}`,
      `DTSTART:${formatICSTime(eventDate)}`,
      `DTEND:${formatICSTime(endDate)}`,
      `LOCATION:${location}`,
      'END:VEVENT',
      'END:VCALENDAR'
    ].join('\n');
    
    const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
    const icsUrl = URL.createObjectURL(blob);
    document.getElementById('ics-download').href = icsUrl;
    document.getElementById('ics-download').download = `${title}.ics`;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    document.getElementById('calendar-modal').style.display = 'block';
    
  } catch (error) {
    console.error('Error in addToCalendar:', error);
    alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—å');
  }
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ ICS
function formatICSTime(date) {
  return date.toISOString().replace(/-|:|\.\d+/g, '').slice(0, -1) + 'Z';
}

// –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
function closeCalendarModal() {
  document.getElementById('calendar-modal').style.display = 'none';
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –æ–∫–Ω–∞
document.getElementById('calendar-modal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeCalendarModal();
  }
});

// –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∞–≤–∏—à–µ ESC
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    closeCalendarModal();
  }
});

// –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –≥–ª–æ–±–∞–ª—å–Ω–æ
console.log('Calendar functions loaded:', {
  addToCalendar: typeof addToCalendar,
  closeCalendarModal: typeof closeCalendarModal
});
</script>

<!-- ===== –°–¢–ò–õ–ò –î–õ–Ø –ú–û–î–ê–õ–¨–ù–û–ì–û –û–ö–ù–ê ===== -->
<style>
#calendar-modal {
  transition: opacity 0.3s ease;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è hover-—ç—Ñ—Ñ–µ–∫—Ç–æ–≤ —Å—Å—ã–ª–æ–∫ */
.hover-black-70:hover {
  color: #8B4513 !important;
}
.hover-black-70:hover svg {
  fill: #8B4513 !important;
}
</style>
{{ end }}
